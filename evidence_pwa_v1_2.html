<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Site Evidence Capture (PWA) v1.2</title>
<meta name="theme-color" content="#0f172a" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230f172a'/%3E%3Cpath d='M44 188h168M44 68h168M64 96h40M64 160h40M132 80l24 24l36-36' stroke='%23fff' stroke-width='14' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
<link rel="manifest" href="./manifest.webmanifest" />
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.75));backdrop-filter:blur(6px);border-bottom:1px solid #111}
  .wrap{max-width:1040px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid #222;border-radius:16px;padding:16px}
  button,.btn{cursor:pointer;border:1px solid #333;background:#1f2937;color:var(--text);padding:10px 14px;border-radius:12px}
  button:disabled{opacity:.5;cursor:not-allowed}
  .primary{background:#16a34a;border-color:#15803d}
  .danger{background:#991b1b;border-color:#7f1d1d}
  .warn{background:#b45309;border-color:#92400e}
  select,input[type="number"],input[type="text"]{background:#111827;color:var(--text);border:1px solid #333;border-radius:10px;padding:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid #333;background:#0b1220}
  .thumb canvas{width:100%;height:auto;display:block}
  .meta{padding:8px 10px;border-top:1px solid #222;font-size:14px}
  .meta small{opacity:.7}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b4; font-size:12px; margin-left:6px}
  .footer{opacity:.8;font-size:13px}
  dialog{border:none;border-radius:16px;padding:0;max-width:520px;width:90%;background:#0b1220;color:var(--text)}
  dialog header{padding:16px;border-bottom:1px solid #222}
  dialog .content{padding:16px}
  dialog .actions{display:flex;gap:10px;justify-content:flex-end;padding:16px;border-top:1px solid #222}
  .count{font-variant-numeric: tabular-nums}
  .hint{opacity:.7;font-size:12px}

  /* Slide-out panel for sessions */
  .section {
    position: fixed;
    top: 0;
    left: 0;
    width: min(360px, 92vw);
    height: 100%;
    transition: transform 0.28s ease; /* Smooth slide-in/out */
    z-index: 1000;
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
    border-right: 1px solid #222;
    overflow: auto;
    background: var(--card);
    padding: 16px;
    transform: translateX(-110%); /* Hidden by default */
  }
  .section.open {
    transform: translateX(0); /* Slide in when open */
  }
  .tab-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .tab {
    flex: 1;
    padding: 10px;
    border: 1px solid #333;
    border-radius: 8px;
    background: var(--card);
    color: var(--text);
    cursor: pointer;
    transition: background .2s;
  }
  .tab:hover {
    background: #1f2937;
  }
  .tab.active {
    background: #15803d;
    color: #fff;
  }
  .close {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 18px;
    cursor: pointer;
  }

  /* Session Manager styles */
  .sessions-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: min(360px, 92vw);
    height: 100%;
    background: var(--card, #1a1a2b);
    color: var(--fg, #eef4ff);
    border-right: 1px solid var(--border, #444c6a);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    padding: 16px;
    overflow-y: auto;
    z-index: 1000;
    transform: translateX(-110%); /* Hidden by default */
    transition: transform 0.28s ease;
  }
  .sessions-panel.open {
    transform: translateX(0); /* Visible when open */
  }
  body.sessions-open #sessionsToggle {
    opacity: 1; /* Ensure the button is fully visible */
    pointer-events: auto; /* Allow interaction */
  }
  .sessions-header-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sessions-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }
  .flex-spacer {
    flex: 1;
  }
  .sessions-hint {
    margin-top: 6px;
    font-size: 0.9rem;
    color: var(--muted, #8b93b8);
  }
  .sessions-new-btn-row {
    margin-top: 8px;
  }
  .sessions-list {
    list-style: none;
    padding: 0;
    margin-top: 10px;
  }
  .session-tab {
    display: inline-flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    gap: 8px;
    padding: 8px 10px;
    margin-bottom: 8px;
    border-radius: 10px;
    border: 1px solid var(--border, #444c6a);
    background: var(--card, #1a1a2b);
    color: var(--fg, #eef4ff);
    font-weight: 600;
    text-align: left;
    cursor: pointer;
  }
  .session-tab.active {
    outline: 3px solid var(--focus-ring, #7aa9f6);
    outline-offset: 0;
  }
  .session-close-btn {
    background: transparent;
    border: 0;
    color: var(--muted, #8b93b8);
    cursor: pointer;
    padding: 0 4px;
    font-size: 0.9rem;
    line-height: 1;
  }
  .session-summary-chip {
    display: inline-block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--muted, #8b93b8);
    border: 1px solid var(--border, #444c6a);
    background: rgba(127, 146, 190, 0.08);
    border-radius: 999px;
    padding: 2px 8px;
    max-width: 40vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Update styles for the renamed Collections panel */
  .collections-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: min(360px, 92vw);
    height: 100%;
    background: var(--card, #1a1a2b);
    color: var(--fg, #eef4ff);
    border-right: 1px solid var(--border, #444c6a);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    padding: 16px;
    overflow-y: auto;
    z-index: 1000;
    transform: translateX(-110%); /* Hidden by default */
    transition: transform 0.28s ease;
  }
  .collections-panel.open {
    transform: translateX(0); /* Slide in when open */
  }
  body.collections-open #collectionsToggle {
    opacity: 1;
    pointer-events: auto;
  }

  /* Collection Parameters slide-out (left) */
  .params-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: min(360px, 92vw);
    height: 100%;
    background: var(--card);
    color: var(--text);
    border-right: 1px solid #222;
    box-shadow: 8px 0 24px rgba(0,0,0,0.6);
    padding: 16px;
    transform: translateX(-110%);
    transition: transform 0.28s ease;
    z-index: 1200;
    overflow-y: auto;
  }
  .params-panel.open { transform: translateX(0); }
  .params-panel h3 { margin:0 0 8px; font-size:1rem; font-weight:600; }
  .params-panel .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }

  /* location button state colours */
  .btn.loc-on { background:#16a34a !important; border-color:#15803d !important; color:#fff; }
  .btn.loc-off { background:#991b1b !important; border-color:#7f1d1d !important; color:#fff; }

  /* make svg inside control inherit button foreground */
  .btn svg { vertical-align: middle; fill: none; stroke: currentColor; }

  /* icon-only button style (tight square for header icons) */
  .btn.icon-btn { width:40px; height:40px; padding:6px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; }

  /* export button: inline icon + label, slightly tighter */
  .btn.export { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; font-weight:600; }
  .btn.export svg { width:18px; height:18px; }

  /* group two buttons so they look related (export + settings) */
  .btn.group-left { border-top-right-radius:0; border-bottom-right-radius:0; margin-left:8px; }
  .btn.group-right { border-top-left-radius:0; border-bottom-left-radius:0; margin-left:0; border-left:1px solid rgba(0,0,0,0.25); }

  /* keep grouped header buttons together on small screens */
  .btn-group {
    display: inline-flex;
    flex-wrap: nowrap;
    gap: 0;
    align-items: center;
    white-space: nowrap;
  }
  .btn-group .btn {
    flex: 0 0 auto; /* do not grow or shrink */
  }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="font-weight:700;font-size:18px;letter-spacing:.2px">Site Evidence Capture <span style="opacity:.6;font-weight:500">v1.2</span></div>
    <div id="tabsSummary" style="margin-left: 16px; font-weight: 500; opacity: 0.8;"></div>
    <!-- inside header controls: add settings cog button (keeps id btnSettings) -->
    <div class="row" style="margin-left:auto">
      <span class="count" id="count">0 items</span>

      <!-- Location icon (moved from middle). id preserved for JS -->
      <button id="btnEnableLoc" class="btn loc-off icon-btn" title="Enable location" aria-pressed="false" style="margin-right:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C8.686 2 6 4.686 6 8c0 5.25 6 12 6 12s6-6.75 6-12c0-3.314-2.686-6-6-6z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="8" r="2.2" stroke="currentColor" stroke-width="1.2" fill="none"/>
        </svg>
      </button>

      <button id="collectionsToggle" class="btn">Collections</button>

      <!-- Group Export + Settings so they never wrap apart -->
      <span class="btn-group" style="margin-left:8px">
        <button id="btnExportPPTX" class="btn danger export group-left" title="Export PPTX" aria-label="Export PPTX">
          <!-- slideshow/presentation icon -->
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="14" rx="2" />
            <path d="M8 9h8M8 13h5" />
            <path d="M12 18v3" />
          </svg>
          <span>PPTX</span>
        </button>
        <button id="btnSettings" class="btn group-right" title="Settings" aria-label="Settings">
          <!-- inline cog SVG -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="#e5e7eb" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09c.73 0 1.38-.39 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 0 1 6.4 3.7l.06.06c.47.47 1.1.7 1.75.62.62-.08 1.18-.48 1.4-1.06.2-.54.7-.94 1.28-1.06L12 2.5c.36 0 .72.1 1.03.28.58.28 1.03.78 1.22 1.4.22.68.78 1.09 1.4 1.17.65.08 1.28-.15 1.75-.62l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06c-.47.47-.7 1.1-.62 1.75.08.62.48 1.18 1.06 1.4.68.22 1.09.78 1.17 1.4V11a2 2 0 0 1 0 4h-.09c-.73 0-1.38.39-1.51 1z" stroke="#e5e7eb" stroke-width="0.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </span>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:14px;padding-bottom:72px">
  <section class="card">
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="btnSnap" class="primary">Take / Select Photo</button>

      <!-- location control moved to header; status text removed (indicator is the icon colour) -->

      <!-- Moved here: Parameters and Clear Collection -->
      <button id="paramsToggle" class="btn" title="Open collection parameters" style="margin-left:8px">Params</button>
      <button id="btnClear" class="btn danger" title="Clears all items in the current collection" style="margin-left:8px">Clear Collection</button>

      <!-- layout/orientation moved into Settings panel -->
      <input id="collectionTitle" type="hidden" value="Site Evidence Photos" />
    </div>

    <!-- New: Client, Project Title, and Photographer fields (moved to slide-out panel — keep hidden fields for compatibility) -->
    <div style="display:none;">
      <input id="clientName" type="hidden" value="" />
      <input id="projectTitle" type="hidden" value="" />
      <input id="photographerName" type="hidden" value="" />
    </div>

    <!-- Slide-out settings panel -->
    <div id="settingsPanel" style="position:fixed;right:-320px;top:72px;width:320px;max-width:90vw;height:calc(100vh - 96px);background:var(--card);border-left:1px solid #222;padding:16px;border-radius:8px 0 0 8px;box-shadow:-8px 0 24px rgba(0,0,0,.6);transition:right .25s ease;z-index=40">
      <h3 style="margin:0 0 8px">Settings</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <label>Max width (px):
          <input id="maxw" type="number" min="800" max="4096" value="1920" style="width:100%" />
        </label>
        <label>Layout:
          <select id="layout" style="width:100%">
            <option value="2">2 per A4 page</option>
            <option value="4" selected>4 per A4 page</option>
          </select>
        </label>
        <label>Orientation:
          <select id="orientation" style="width:100%">
            <option value="portrait">Portrait (A4)</option>
            <option value="landscape" selected>Landscape (A4)</option>
          </select>
        </label>
        <label>Margins (mm):
          <input id="margins" type="number" min="0" max="30" value="10" style="width:100%" />
        </label>
        <div style="margin-top:6px"><small class="hint">These affect exports (A4 sizing)</small></div>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button id="btnCloseSettings" class="btn">Close</button>
      </div>
    </div>

    <p class="footer" style="margin:8px 0 0">
      Camera is forced to landscape: portrait images are auto-rotated. Captures stored offline (IndexedDB). Exports honour layout and A4 sizing.
    </p>
  </section>

  <section id="gallery" class="grid" style="margin-top:14px"></section>
</main>

<!-- Description dialog -->
<dialog id="descDialog">
  <header><strong>Add description</strong></header>
  <div class="content">
    <p style="margin:0 0 8px">Describe the evidence in one or two lines (who/what/where/why).</p>
    <textarea id="descText" rows="4" style="width:100%;resize:vertical;background:#0a0f1e;color:#fff;border:1px solid #333;border-radius:10px;padding:10px" placeholder="e.g., TP03: Sub-base compaction adjacent to gridline C–D. Roller: Bomag BW120."></textarea>
    <div class="row" style="margin-top:8px">
      <label>Date/time:
        <!-- include seconds support for datetime-local -->
        <input id="descWhen" type="datetime-local" step="1" />
      </label>
      <label>Technician:
        <input id="descTech" type="text" placeholder="initials / name" />
      </label>
      <!-- Removed free-text location field — GPS position only (descPosition) -->
    </div>
    <div style="margin-top:8px">
      <label style="display:block;font-size:13px;margin-bottom:6px">Position (device → BNG) <span class="hint" style="font-size:12px">(*) approximate</span></label>
      <input id="descPosition" type="text" readonly style="width:100%;background:#07101a;color:#cfe; border:1px solid #223;border-radius:8px;padding:8px" />
    </div>
  </div>
  <div class="actions">
    <button id="descCancel">Cancel</button>
    <button id="descOK" class="primary">Save</button>
  </div>
</dialog>

<!-- Rename the slide-out panel for managing collections -->
<div id="collections" class="collections-panel" aria-hidden="true">
  <div class="collections-header-row" style="display:flex;align-items:center;gap:8px;">
    <button id="collectionsClose" class="btn" type="button">Close</button>
    <h2 class="collections-title" style="margin:0;font-size:1rem;font-weight:600;">Collections</h2>
    <div class="flex-spacer" style="flex:1;"></div>
  </div>
  <p class="collections-hint">Manage active collections. Click one to switch to it.</p>
  <div class="collections-new-btn-row" style="margin-top:8px;">
    <button id="newCollectionBtn" class="btn" type="button">＋ New Collection</button>
  </div>
  <ul id="collectionsList" class="collections-list" style="list-style:none;padding:0;margin-top:10px;"></ul>
</div>

<!-- Add the params panel markup (place near other slide-out panels) -->
<div id="paramsPanel" class="params-panel" aria-hidden="true">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <button id="paramsClose" class="btn" type="button">Close</button>
    <h3 style="margin:0">Collection Parameters</h3>
  </div>

  <div style="margin-top:8px">
    <div class="field">
      <label style="font-size:12px">Collection name</label>
      <input id="params_collectionTitle" type="text" placeholder="Collection name" />
    </div>
    <div class="field">
      <label style="font-size:12px">Client</label>
      <input id="params_clientName" type="text" placeholder="Client" />
    </div>
    <div class="field">
      <label style="font-size:12px">Project Title</label>
      <input id="params_projectTitle" type="text" placeholder="Project title" />
    </div>
    <div class="field">
      <label style="font-size:12px">Photographer</label>
      <input id="params_photographerName" type="text" placeholder="Photographer" />
    </div>
    <div style="margin-top:12px;text-align:right">
      <button id="paramsSave" class="btn primary">Save</button>
    </div>
  </div>
</div>

<!-- Active session summary -->
<div id="activeSessionSummary" class="session-summary-chip"></div>

<!-- Libraries (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js" crossorigin="anonymous"></script>
<!-- include the helper as an ES module so addBottomRightTable is available -->
<script type="module" src="./pptx_table.js"></script>

<script>
/* ---------------- PWA: manifest + service worker (self-contained) ---------------- */
(function bootstrapPWA(){
  const manifest = {
    "name": "Site Evidence Capture",
    "short_name": "EvidenceCam",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#0f172a",
    "theme_color": "#0f172a",
    "orientation": "landscape",
    "icons": [
      {"src":"icon-192.png","sizes":"192x192","type":"image/png"},
      {"src":"icon-512.png","sizes":"512x512","type":"image/png"},
      {"src":"icon-maskable.png","sizes":"512x512","type":"image/png","purpose":"maskable any"}
    ]
  };
  const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'}));
  document.head.appendChild(Object.assign(document.createElement('link'), { rel:'manifest', href: manifestURL }));

  function makeIcon(size){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const g=c.getContext('2d');
    g.fillStyle='#0f172a'; g.fillRect(0,0,size,size);
    g.strokeStyle='#22c55e'; g.lineWidth=size*0.06;
    g.strokeRect(size*0.14,size*0.14,size*0.72,size*0.72);
    g.fillStyle='#22c55e'; g.fillRect(size*0.25,size*0.55,size*0.5,size*0.12);
    return c.toDataURL('image/png');
  }
  document.head.appendChild(Object.assign(document.createElement('link'),{rel:'icon',sizes:'192x192',href:makeIcon(192)}));
  document.head.appendChild(Object.assign(document.createElement('link'),{rel:'icon',sizes:'512x512',href:makeIcon(512)}));

  const swCode = `
  const CACHE_NAME='evidencecam-v4';
  const ASSETS=[
    './',
    './pptx_table.js',
    './brownfield_logo.png',
    'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js'
  ];
  self.addEventListener('install',e=>{
    e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
  });
  self.addEventListener('activate',e=>{
    e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k)))) .then(()=>self.clients.claim()));
  });
  self.addEventListener('fetch',e=>{
    e.respondWith(
      caches.match(e.request).then(cachedResponse => {
        if (cachedResponse) {
          return cachedResponse;
        }
        return fetch(e.request).then(networkResponse => {
          // Caching for non-asset requests (e.g. future API calls)
          const responseToCache = networkResponse.clone();
          caches.open(CACHE_NAME).then(cache => {
            cache.put(e.request, responseToCache);
          });
          return networkResponse;
        }).catch(() => {
          // Fallback for failed fetch, e.g. a generic offline page/image
          // For now, just fails, but could return a placeholder from cache.
        });
      })
    );
  });
  `;
  const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
  if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL); }
})();
</script>

<script>
/* ---------------- Minimal IndexedDB ---------------- */
const DB_NAME='evidenceDB', STORE='items', SESSIONS_STORE='sessions';
function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 2); // DB version 2
    req.onupgradeneeded = (event) => {
      const db = event.target.result;
      // create legacy items store if missing
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
      }
      // create sessions store if missing (autoIncrement per spec)
      if (!db.objectStoreNames.contains(SESSIONS_STORE)) {
        db.createObjectStore(SESSIONS_STORE, { keyPath: 'id', autoIncrement: true });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
    req.onblocked = () => console.warn('IndexedDB open blocked - close other tabs using this site to upgrade the database.');
  });
}
async function idbAdd(obj){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).add(obj).onsuccess=e=>res(e.target.result); tx.onerror=()=>rej(tx.error); }); }
async function idbAll(){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); }); }

// New helpers for sessions store
async function idbAddSession(session){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(SESSIONS_STORE,'readwrite'); tx.objectStore(SESSIONS_STORE).put(session).onsuccess=()=>res(); tx.onerror=()=>rej(tx.error); }); }
async function idbGetSession(id){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(SESSIONS_STORE,'readonly'); const req=tx.objectStore(SESSIONS_STORE).get(id); req.onsuccess=()=>res(req.result||null); req.onerror=()=>rej(req.error); }); }
async function idbAllSessions(){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(SESSIONS_STORE,'readonly'); const req=tx.objectStore(SESSIONS_STORE).getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); }); }
async function idbDeleteSession(id){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(SESSIONS_STORE,'readwrite'); tx.objectStore(SESSIONS_STORE).delete(id).onsuccess=()=>res(); tx.onerror=()=>rej(tx.error); }); }

/* ---------------- App state + UI refs ---------------- */
const state = { items: [], client: '', project: '', photographer: '' }; // Add photographer to state
const fileInput = document.getElementById('fileInput');
const btnSnap = document.getElementById('btnSnap');
const gallery = document.getElementById('gallery');
const collectionTitleInput = document.getElementById('collectionTitle');
const clientNameInput = document.getElementById('clientName'); // New
const projectTitleInput = document.getElementById('projectTitle'); // New
const photographerNameInput = document.getElementById('photographerName'); // New
const descDialog = document.getElementById('descDialog');
const descText = document.getElementById('descText');
const descWhen = document.getElementById('descWhen');
const descTech = document.getElementById('descTech');
const descPosition = document.getElementById('descPosition');
const descOK = document.getElementById('descOK');
const descCancel = document.getElementById('descCancel');
const btnExportPPTX = document.getElementById('btnExportPPTX');
const btnClear = document.getElementById('btnClear');
const layoutSel = document.getElementById('layout');
const orientationSel = document.getElementById('orientation');
const maxwInput = document.getElementById('maxw');
const marginsInput = document.getElementById('margins');
const countEl = document.getElementById('count');

const btnEnableLoc = document.getElementById('btnEnableLoc');
const btnSettings = document.getElementById('btnSettings');
const settingsPanel = document.getElementById('settingsPanel');
const btnCloseSettings = document.getElementById('btnCloseSettings');

// location state
let pendingCanvas=null;
let pendingGPS=null;
let locationEnabled = false;      // do NOT start watch automatically — user must click
let lastKnownPos = null;          // stores last accepted high-accuracy position
let watchId = null;

// wire up missing handlers
btnSnap.addEventListener('click', ()=> fileInput.click());
btnSettings.addEventListener('click', ()=> { settingsPanel.style.right = (settingsPanel.style.right === '0px') ? '-320px' : '0px'; });
btnCloseSettings.addEventListener('click', ()=> { settingsPanel.style.right = '-320px'; });
// also allow closing when panel is open and user clicks outside (optional)
document.addEventListener('keydown', e=>{ if(e.key === 'Escape'){ settingsPanel.style.right='-320px'; descDialog.close?.(); } });

function fmtBNGDisplay(pos){
  if(!pos) return '';
  const accText = `≈${Math.round(pos.accuracy||3)} m`;
  if(typeof pos.bngE !== 'undefined' && typeof pos.lat === 'number' && typeof pos.lon === 'number'){
    return `BNG: E ${pos.bngE} N ${pos.bngN}* | Lat ${pos.lat.toFixed(6)}, Lon ${pos.lon.toFixed(6)} (${accText})`;
  }
  if(typeof pos.lat === 'number' && typeof pos.lon === 'number'){
    return `Lat ${pos.lat.toFixed(6)}, Lon ${pos.lon.toFixed(6)} (${accText})`;
  }
  return '';
}

function startWatch(){
  if(!navigator.geolocation || watchId) return;
  try{
    watchId = navigator.geolocation.watchPosition(pos=>{
      try{
        const lat = pos.coords.latitude, lon = pos.coords.longitude, acc = pos.coords.accuracy;
        const bng = latLonToBNG(lat, lon); // latLonToBNG()
        lastKnownPos = { lat, lon, accuracy: acc, bngE: bng.easting, bngN: bng.northing };
        pendingGPS = lastKnownPos;
        // update dialog field if open
        if(descDialog.open){
          descPosition.value = fmtBNGDisplay(lastKnownPos);
        }
        // visual indicator & tooltip include accuracy
        setLocationButtonState(true, Math.round(acc||0));
      }catch(err){
        console.warn('watchPosition -> BNG convert failed', err);
      }
    }, err=>{
      console.warn('watchPosition error', err);
      // turn off visual indicator on errors (permission/unavailable/etc)
      setLocationButtonState(false);
    }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
  }catch(e){
    console.warn('startWatch failed', e);
    setLocationButtonState(false);
  }
}

function stopWatch(){
  if(watchId !== null && navigator.geolocation){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    // visual reset: icon shows disabled
    setLocationButtonState(false);
  }
}

btnEnableLoc.addEventListener('click', async ()=>{
  // If watch already running, stop it
  if(watchId){
    stopWatch();
    locationEnabled = false;
    setLocationButtonState(false);
    return;
  }

  // User gesture: do a one‑shot getCurrentPosition to force browser permission prompt,
  // then start watchPosition if permission is granted.
  // show ephemeral request state in button tooltip
  btnEnableLoc.setAttribute('title','Requesting…');
  const pos = await requestLocationOnce();
  if(!pos){
    setLocationButtonState(false, 'Denied / unavailable');
    return;
  }

  try{
    const lat = pos.coords.latitude, lon = pos.coords.longitude, acc = pos.coords.accuracy;
    const bng = latLonToBNG(lat, lon);
    lastKnownPos = { lat, lon, accuracy: acc, bngE: bng.easting, bngN: bng.northing };
    pendingGPS = lastKnownPos;
    descPosition.value = fmtBNGDisplay(lastKnownPos);
    // now start continuous watch (will not re-prompt)
    startWatch();
    locationEnabled = true;
    setLocationButtonState(true, Math.round(acc||0));
  }catch(err){
    console.warn('Enable location failed', err);
    setLocationButtonState(false, 'Error');
  }
});

/* helper to set location button visual state (green when enabled, red when off) */
function setLocationButtonState(enabled, accOrMsg){
  const btn = document.getElementById('btnEnableLoc');
  if(!btn) return;
  if(enabled){
    btn.classList.remove('loc-off'); btn.classList.add('loc-on');
    const title = (typeof accOrMsg === 'number') ? `Disable location (≈${accOrMsg} m)` : 'Disable location';
    btn.setAttribute('title', title);
    btn.setAttribute('aria-pressed','true');
  }else{
    btn.classList.remove('loc-on'); btn.classList.add('loc-off');
    const title = (typeof accOrMsg === 'string') ? accOrMsg : 'Enable location';
    btn.setAttribute('title', title);
    btn.setAttribute('aria-pressed','false');
  }
}

/* initialize location button visual state (off by default) */
document.addEventListener('DOMContentLoaded', ()=> {
  setLocationButtonState(false);
});

/* ---------------- Helpers needed by capture / UI ---------------- */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
function fmtCount(n){ return `${n} item${n===1?'':'s'}`; }
function toDataURL(canvas, quality=0.92){ return canvas.toDataURL('image/jpeg', quality); }

function dataURLtoBlob(dataURL){
  const parts = dataURL.split(',');
  const mime = parts[0].match(/:(.*?);/)[1];
  const binStr = atob(parts[1]);
  const len = binStr.length;
  const u8 = new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i]=binStr.charCodeAt(i);
  return new Blob([u8], {type:mime});
}

/** Normalize an image file to a landscape canvas (rotate if portrait), scale to maxW
    - Loads image reliably into an HTMLImageElement
    - Preserves aspect ratio
    - Rotates portrait sources 90° to yield landscape output
*/
async function normalizeToLandscape(file, maxW){
  // helper to load an image element from a File/Blob
  const loadImg = (blob) => new Promise((res, rej) => {
    const img = new Image();
    img.onload = () => res(img);
    img.onerror = (e) => rej(e);
    // Avoid tainting from cross-origin; blob URL is same-origin
    img.src = URL.createObjectURL(blob);
  });

  const img = await loadImg(file);

  // source dimensions
  const sw = img.width;
  const sh = img.height;

  // determine if source is portrait and compute scale based on longest side
  const sourceLong = Math.max(sw, sh);
  const scale = Math.min(1, (maxW || 1920) / sourceLong);

  // When rotating a portrait, output dimensions swap
  const rotate = sh > sw;
  const outW = Math.round((rotate ? sh : sw) * scale);
  const outH = Math.round((rotate ? sw : sh) * scale);

  const canvas = document.createElement('canvas');
  canvas.width = outW;
  canvas.height = outH;
  const ctx = canvas.getContext('2d');

  if (rotate) {
    // Rotate 90deg clockwise and draw the scaled image centered.
    ctx.save();
    // translate to canvas center and rotate
    ctx.translate(outW / 2, outH / 2);
    ctx.rotate(Math.PI / 2);
    // draw the image centered at the origin, scaled
    const dw = Math.round(sw * scale);
    const dh = Math.round(sh * scale);
    ctx.drawImage(img, -dw / 2, -dh / 2, dw, dh);
    ctx.restore();
  } else {
    // Landscape: draw scaled to fit canvas
    const dw = Math.round(sw * scale);
    const dh = Math.round(sh * scale);
    // center within canvas (should equal canvas size normally)
    const dx = Math.round((outW - dw) / 2);
    const dy = Math.round((outH - dh) / 2);
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  // release object URL created by loadImg (best-effort)
  try { URL.revokeObjectURL(img.src); } catch (e) {}

  return canvas;
}

/* ---------------- British National Grid conversion helpers ----------------
   WGS84 -> OSGB36 Helmert transform + Transverse Mercator
   returns {easting, northing}
*/
function deg2rad(d){ return d * Math.PI/180; }
function latLonToBNG(lat, lon){
  const aW = 6378137.0, bW = 6356752.3141;
  const aA = 6377563.396, bA = 6356256.909;
  const tx = -446.448, ty = 125.157, tz = -542.060;
  const rxSec = -0.1502, rySec = -0.2470, rzSec = -0.8421;
  const sppm = 20.4894;

  const latR = deg2rad(lat), lonR = deg2rad(lon);
  const e2W = (aW*aW - bW*bW) / (aW*aW);
  const vW = aW / Math.sqrt(1 - e2W * Math.sin(latR)*Math.sin(latR));
  const xW = vW * Math.cos(latR) * Math.cos(lonR);
  const yW = vW * Math.cos(latR) * Math.sin(lonR);
  const zW = (vW * (1 - e2W)) * Math.sin(latR);

  const rx = rxSec / 3600 * Math.PI/180;
  const ry = rySec / 3600 * Math.PI/180;
  const rz = rzSec / 3600 * Math.PI/180;
  const s = sppm * 1e-6 + 1;

  const xO = tx + s*( xW + (-rz)*yW + ry*zW );
  const yO = ty + s*( rz*xW + yW + (-rx)*zW );
  const zO = tz + s*( (-ry)*xW + rx*yW + zW );

  const e2A = (aA*aA - bA*bA) / (aA*aA);
  let p = Math.sqrt(xO*xO + yO*yO);
  let latA = Math.atan2(zO, p * (1 - e2A));
  let latPrev = 1e9, vA;
  while(Math.abs(latA - latPrev) > 1e-12){
    latPrev = latA;
    vA = aA / Math.sqrt(1 - e2A * Math.sin(latA)*Math.sin(latA));
    latA = Math.atan2(zO + e2A * vA * Math.sin(latA), p);
  }
  const lonA = Math.atan2(yO, xO);

  const lat0 = deg2rad(49.0), lon0 = deg2rad(-2.0);
  const N0 = -100000.0, E0 = 400000.0, F0 = 0.9996012717;
  const n = (aA - bA) / (aA + bA);
  const nu = aA * F0 / Math.sqrt(1 - e2A * Math.sin(latA)*Math.sin(latA));
  const rho = aA * F0 * (1 - e2A) / Math.pow(1 - e2A * Math.sin(latA)*Math.sin(latA), 1.5);
  const eta2 = nu / rho - 1;

  const M = aA * F0 * (
    (1 + n + (5/4)*n*n + (5/4)*n*n*n) * (latA - lat0)
    - (3*n + 3*n*n + (21/8)*n*n*n) * Math.sin(latA - lat0) * Math.cos(latA + lat0)
    + ((15/8)*n*n + (15/8)*n*n*n) * Math.sin(2*(latA - lat0)) * Math.cos(2*(latA + lat0))
    - (35/24)*n*n*n * Math.sin(3*(latA - lat0)) * Math.cos(3*(latA + lat0))
  );

  const I = M + N0;
  const II = (nu/2) * Math.sin(latA) * Math.cos(latA);
  const III = (nu/24) * Math.sin(latA) * Math.pow(Math.cos(latA),3) * (5 - Math.tan(latA)*Math.tan(latA) + 9*eta2);
  const IIIA = (nu/720) * Math.sin(latA) * Math.pow(Math.cos(latA),5) * (61 - 58*Math.tan(latA)*Math.tan(latA) + Math.pow(Math.tan(latA),4));
  const IV = nu * Math.cos(latA);
  const V = (nu/6) * Math.pow(Math.cos(latA),3) * (nu/rho - Math.tan(latA)*Math.tan(latA));
  const VI = (nu/120) * Math.pow(Math.cos(latA),5) * (5 - 18*Math.tan(latA)*Math.tan(latA) + Math.pow(Math.tan(latA),4) + 14*eta2 - 58*Math.tan(latA)*Math.tan(latA)*eta2);

  const dLon = lonA - lon0;
  const dLon2 = dLon*dLon, dLon3 = dLon2*dLon, dLon4 = dLon3*dLon, dLon5 = dLon4*dLon, dLon6 = dLon5*dLon;

  const N = I + II*dLon2 + III*dLon4 + IIIA*dLon6;
  const E = E0 + IV*dLon + V*dLon3 + VI*dLon5;

  return { easting: Math.round(E), northing: Math.round(N) };
}

/* getCurrentPosition-style single read (used as quick attempt when saving) */
function requestLocationOnce(){
  if(!navigator.geolocation) return Promise.resolve(null);
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      resolve(pos);
    }, err=>{
      console.warn('Geolocation getCurrentPosition failed', err);
      resolve(null);
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  });
}

/* Render gallery from state.items (uses item._preview canvas if present) */
function renderGallery(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  state.items.forEach(item=>{
    const card=document.createElement('div'); card.className='thumb';
    const c=document.createElement('canvas'); c.width=item.w || (item._preview && item._preview.width) || 800; c.height=item.h || (item._preview && item._preview.height) || 600;
    const ctx = c.getContext('2d');
    if(item._preview) ctx.drawImage(item._preview,0,0);
    const meta=document.createElement('div'); meta.className='meta';
    const when=item.whenISO?new Date(item.whenISO):new Date(item.created);
    let gpsText = '';
    if(item.gps){
      if(typeof item.gps.bngE !== 'undefined'){
        gpsText = ` • ${fmtBNGDisplay(item.gps)}`;
      }else if(typeof item.gps.lat === 'number' && typeof item.gps.lon === 'number'){
        gpsText = ` • Lat ${item.gps.lat.toFixed(6)}, Lon ${item.gps.lon.toFixed(6)} (≈${Math.round(item.gps.accuracy||3)} m)`;
      }
    }
    meta.innerHTML = `<div><strong>${escapeHTML(item.desc||'(no description)')}</strong><span class="badge">${c.width}×${c.height}</span></div>
      <small>${when.toLocaleString()}${gpsText} • ${escapeHTML(item.tech||'')} • ${escapeHTML(item.loc||'')}</small>`;
    
    // Add delete button for individual image removal (removes from current collection)
    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '5px';
    deleteBtn.style.right = '5px';
    deleteBtn.style.background = 'transparent';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '0';
    deleteBtn.style.width = '20px';
    deleteBtn.style.height = '20px';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.title = 'Delete this image';
    deleteBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this image from this collection?')) return;
      const index = state.items.indexOf(item);
      if (index > -1) {
        state.items.splice(index, 1);
        saveGlobalsToSession(activeSessionId);
        renderGallery();
      }
    });
    
    card.appendChild(c); card.appendChild(meta); card.appendChild(deleteBtn);
    gallery.appendChild(card);
  });
  const countEl = document.getElementById('count');
  countEl.textContent = fmtCount(state.items.length);
}

fileInput.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const maxW = parseInt(maxwInput.value,10)||1920;
    pendingCanvas = await normalizeToLandscape(f, maxW);

    // start location lookup (best-effort) and store in pendingGPS
    pendingGPS = null;
    // Only attempt an automatic fresh lookup if permission is already granted or user enabled location
    try{
      const perm = navigator.permissions ? await navigator.permissions.query({ name:'geolocation' }) : null;
      if((perm && perm.state === 'granted') || locationEnabled){
        // attempt a quick fresh high-accuracy read (best-effort)
        const pos = await requestLocationOnce();
        if(pos){
          try{
            const lat = pos.coords.latitude, lon = pos.coords.longitude, acc = pos.coords.accuracy;
            const bng = latLonToBNG(lat, lon);
            pendingGPS = { lat, lon, accuracy: acc, bngE: bng.easting, bngN: bng.northing };
            lastKnownPos = pendingGPS;
          }catch(err){
            console.warn('BNG conversion failed', err);
          }
        }else if(lastKnownPos){
          // fallback to last known if fresh read failed
          pendingGPS = lastKnownPos;
        }
      }else{
        // do not prompt — user must click "Enable Location"
        pendingGPS = null;
      }
    }catch(e){
      console.warn('Permission check / geolocation failed', e);
    }
    descText.value='';
    const now = new Date();
    // include seconds (slice to 19 to get YYYY-MM-DDTHH:MM:SS)
    descWhen.value = new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,19);
    // populate position field in dialog using pendingGPS or lastKnownPos (watch supplies lastKnownPos)
    const posToShow = pendingGPS || lastKnownPos;
    descPosition.value = fmtBNGDisplay(posToShow);
    descDialog.showModal();
  }catch(err){ alert('Failed to process image: '+err); }
  finally{ fileInput.value=''; }
});
descCancel.addEventListener('click', ()=>{ pendingCanvas=null; pendingGPS=null; descDialog.close(); });
descOK.addEventListener('click', async ()=>{
  if(!pendingCanvas) { descDialog.close(); return; }
  const dataURL = toDataURL(pendingCanvas, 0.9);
  const item = {
    dataURL,
    w: pendingCanvas.width,
    h: pendingCanvas.height,
    desc: descText.value.trim(),
    whenISO: descWhen.value? new Date(descWhen.value).toISOString(): null,
    tech: descTech.value.trim(),
    loc: '', // free-text location removed — keep empty, GPS stored under gps
    created: new Date().toISOString(),
    gps: pendingGPS // may be null if unavailable
   };
   const id = await idbAdd(item);
   item.id=id; item._preview=pendingCanvas;
   state.items.push(item);
   saveGlobalsToSession(activeSessionId); // Persist immediately after adding
   renderGallery();
   pendingCanvas=null; pendingGPS=null; descDialog.close();
 });
 
// do NOT start watching automatically — require user gesture
async function openCollectionsPanel() {
  const panel = document.getElementById('collections');
  if (!panel) {
    console.error('Collections panel not found');
    return;
  }
  panel.classList.add('open');
  panel.setAttribute('aria-hidden', 'false');
  document.body.classList.add('collections-open');
}

async function closeCollectionsPanel() {
  const panel = document.getElementById('collections');
  if (!panel) {
    console.error('Collections panel not found');
    return;
  }
  panel.classList.remove('open');
  panel.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('collections-open');
}

/* ---------- Startup ---------- */
(async function init(){
  await loadPersistedSessions();
})();

btnClear.addEventListener('click', async ()=>{
  if(!confirm('Clear all images from the current collection?')) return;
  state.items = [];
  saveGlobalsToSession(activeSessionId);
  renderGallery();
});

/* ---------- Export helpers that return Blobs ---------- */
async function buildPPTXBlob(fileName){
  if(state.items.length===0) { alert('Nothing to export.'); return null; }
  
  // Ensure current session data is saved before export
  saveGlobalsToSession(activeSessionId);

  const layout = parseInt(layoutSel.value,10); // 1,2,4
  const perSlide = layout;
  const groups = []; for(let i=0;i<state.items.length;i+=perSlide) groups.push(state.items.slice(i,i+perSlide));

  // Create a fresh presentation (do not attempt to load a template)
  const pptx = new PptxGenJS();
  try{
    pptx.defineLayout({ name:'A4PORTRAIT', width:8.27, height:11.69 });
    pptx.defineLayout({ name:'A4LANDSCAPE', width:11.69, height:8.27 });
  }catch(e){/*ignore*/}

  const isLandscape = (orientationSel && orientationSel.value === 'landscape');
  try{ pptx.layout = isLandscape ? 'A4LANDSCAPE' : 'A4PORTRAIT'; }catch(e){}

  // Use margins from settings (mm -> inches)
  const marginsMM = Number(marginsInput.value) || 10;
  const margin = Math.max(0.05, marginsMM / 25.4); // in

  // Slide dimensions based on chosen layout
  const slideW = isLandscape ? 11.69 : 8.27;
  const slideH = isLandscape ? 8.27 : 11.69;

  // Side panel width as proportion of slide width so it scales with orientation
  const sideW = Math.min(2.4, Math.max(1.6, slideW * 0.24)); // clamp to reasonable bounds
  const contentW = slideW - margin*2 - sideW - 0.12; // small gap before side panel
  const contentH = slideH - margin*2;

  // Grid selection: make 2-up side-by-side in landscape, stacked in portrait
  const grid = layout === 1 ? { rows: 1, cols: 1 } : (layout === 2 ? (isLandscape ? { rows: 1, cols: 2 } : { rows: 2, cols: 1 }) : { rows: 2, cols: 2 });
  const cellW = contentW / grid.cols;
  const cellH = contentH / grid.rows;

  // Visual style values
  const blueBar = '8DB2E8';
  const lightGrey = 'F6F8FA';
  const textGrey = '444444';

  // Attempt to load logo data URL once (best-effort). Keep it simple and non-blocking.
  let logoDataUrl = null;
  try{
    const r = await fetch('./brownfield_logo.png', { cache:'no-store' });
    if(r.ok){
      const blob = await r.blob();
      logoDataUrl = await new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.onerror = ()=>res(null);
        fr.readAsDataURL(blob);
      });
    }
  }catch(e){ logoDataUrl = null; }

  let slideIndex = 0;
  let globalPhotoIndex = 0; // sequential numbering across slides

  // Insert helper to draw the entire right panel (logo, desc rows, footer fields)
  function addRightPanel(slide, {
    pptx,
    sideX,
    sideW,
    panelTopY,
    panelH,
    textGrey,
    borderBlue,
    panelFill,
    logoDataUrl,
    pageNumber,
    descItems,        // array of up to 4 { num: 1-based index, text: 'desc...' }
    client,
    project,
    collection,
    photographer
  }) {
    // Internal layout constants
    const innerPadX     = 0.18;
    const innerW        = sideW - (innerPadX * 2);
    const headingFontSize = 12;
    const labelFontSize   = 8;
    const fieldFontSize   = 9;
    const descRowH     = 0.4;
    const descGapY     = 0.08;
    const logoBlockH   = 0.9;
    const postLogoGap  = 0.25;
    const footerLabelH = 0.1;
    const footerBoxH   = 0.27;
    const footerGapY   = 0.15;
    const labelBoxGap  = 0.075; // Increased by 50% from 0.05 to reduce overlap

    // 1. Panel background
    slide.addShape(pptx.ShapeType.rect, { x: sideX, y: panelTopY, w: sideW, h: panelH, fill: { color: panelFill } });

    // --- Top 50% section (Descriptions) ---
    let yCursor = panelTopY + 0.2;
    slide.addText('Photo Descriptions', { x: sideX + innerPadX, y: yCursor, w: innerW, h: 0.3, fontSize: headingFontSize, bold: true, color: textGrey, align: 'left', valign: 'top' });
    yCursor += 0.4;

    for (let i = 0; i < 4; i++) {
      const item = descItems[i];
      slide.addShape(pptx.ShapeType.rect, { x: sideX + innerPadX, y: yCursor, w: innerW, h: descRowH, fill: { color: 'FFFFFF' }, line: { color: borderBlue } });
      if (item) {
        const lineText = item.text && item.text.trim() !== '' ? `${item.num}    ${item.text}` : String(item.num);
        slide.addText(lineText, { x: sideX + innerPadX + 0.08, y: yCursor + 0.08, w: innerW - 0.16, h: descRowH - 0.16, fontSize: fieldFontSize, color: textGrey, align: 'left', valign: 'top' });
      }
      yCursor += descRowH + descGapY;
    }

    // --- Bottom 50% section (Logo and Footer Fields) ---
    let footerCursor = panelTopY + (panelH / 2); // Start at the vertical midpoint

    // Logo
    if (logoDataUrl) {
      slide.addImage({ data: logoDataUrl, x: sideX + innerPadX, y: footerCursor, w: innerW, h: logoBlockH });
    } else {
      slide.addText('BROWNFIELD\nSOLUTIONS', { x: sideX + innerPadX, y: footerCursor + 0.1, w: innerW, h: logoBlockH, fontSize: 12, bold: true, color: textGrey, align: 'left', valign: 'top' });
    }
    footerCursor += logoBlockH + postLogoGap;

    // Footer Fields
    function drawFooterField(label, value) {
      slide.addText(label, { x: sideX + innerPadX, y: footerCursor, w: innerW, h: footerLabelH, fontSize: labelFontSize, bold: true, color: textGrey, align: 'left', valign: 'top' });
      const boxY = footerCursor + footerLabelH + labelBoxGap;
      slide.addShape(pptx.ShapeType.rect, { x: sideX + innerPadX, y: boxY, w: innerW, h: footerBoxH, fill: { color: 'FFFFFF' }, line: { color: borderBlue } });
      if (value && value.trim() !== '') {
        slide.addText(value, { x: sideX + innerPadX + 0.08, y: boxY + 0.05, w: innerW - 0.16, h: footerBoxH - 0.1, fontSize: fieldFontSize, color: textGrey, align: 'left', valign: 'top' });
      }
      footerCursor += footerLabelH + labelBoxGap + footerBoxH + footerGapY;
    }

    drawFooterField('CLIENT', client || '');
    drawFooterField('PROJECT TITLE', project || '');
    drawFooterField('COLLECTION', collection || '');
    drawFooterField('PHOTOGRAPHER', photographer || '');

    // Page number (remains at the absolute bottom of the panel)
    slide.addText(`Page ${pageNumber}`, { x: sideX, y: panelTopY + panelH - 0.3, w: sideW - 0.1, h: 0.2, fontSize: 8, color: textGrey, align: 'right' });
  }

  const activeSession = sessions[activeSessionId] || {};
  for(const group of groups){
    slideIndex++;
    const slide = pptx.addSlide();

    // Background
    try{ slide.addShape(pptx.ShapeType.rect, { x:0, y:0, w:slideW, h:slideH, fill:{ color:'FFFFFF' } }); }catch(e){}

    // Right-hand panel background (keep panel background creation for compatibility)
    const sideX = slideW - margin - sideW;
    try{ slide.addShape(pptx.ShapeType.rect, { x: sideX, y: margin, w: sideW, h: contentH, fill:{ color: lightGrey } }); }catch(e){}

    // Add images to the slide
    group.forEach((item, idx) => {
      const r = Math.floor(idx / grid.cols);
      const c = idx % grid.cols;
      const cellX = margin + c * cellW;
      const cellY = margin + r * cellH;

      // Reserve space for text below image (e.g., 20% of cellH for text)
      const imageH = cellH * 0.8;
      const textY = cellY + imageH + 0.05; // small gap

      // Calculate scaled image size to fit within cellW and imageH, preserving aspect ratio
      const imgAspect = item.w / item.h;
      let imgW = cellW;
      let imgH = imgW / imgAspect;
      if (imgH > imageH) {
        imgH = imageH;
        imgW = imgH * imgAspect;
      }
      // Center the image horizontally
      const imgX = cellX + (cellW - imgW) / 2;
      const imgY = cellY;

      try {
        slide.addImage({ data: item.dataURL, x: imgX, y: imgY, w: imgW, h: imgH });
      } catch (e) {
        console.warn('Failed to add image to slide', e);
      }

      // Add text below the image: photo number and BNG location
      globalPhotoIndex++;
      let locationText = '';
      if (item.gps && typeof item.gps.bngE !== 'undefined') {
        locationText = `BNG: E ${item.gps.bngE} N ${item.gps.bngN}`;
      } else if (item.gps && typeof item.gps.lat === 'number') {
        locationText = `Lat ${item.gps.lat.toFixed(6)}, Lon ${item.gps.lon.toFixed(6)}`;
      }
      const photoText = `Photo ${globalPhotoIndex}`;
      const fullText = locationText ? `${photoText} - ${locationText}` : photoText;
      slide.addText(fullText, { x: cellX + 0.05, y: textY, w: cellW - 0.1, h: cellH - imageH - 0.1, fontSize: 8, color: textGrey, align: 'center' });
    });

    // Build descItems for this slide using the sequential globalPhotoIndex.
    // globalPhotoIndex was incremented while adding images above.
    const startNum = Math.max(1, globalPhotoIndex - group.length + 1);
    const descItems = group.map((item, idx) => ({
      num: startNum + idx,
      text: (item.desc || '').replace(/\r?\n/g, ' ')
    }));

    // Draw the entire right panel using the helper (logo, desc rows, footer fields, page number)
    addRightPanel(slide, {
      pptx,
      sideX,
      sideW,
      panelTopY: margin,
      panelH: contentH,
      textGrey,
      borderBlue: blueBar,
      panelFill: lightGrey,
      logoDataUrl,
      pageNumber: slideIndex,
      descItems,
      client:       activeSession.client || '',
      project:      activeSession.project || '',
      collection:   activeSession.name || '',
      photographer: activeSession.photographer || ''
    });

    // Slide number bottom-right outside panel is now handled by addRightPanel; if you still
    // want an extra page text outside, keep previous call (optional).
  }

  // Write blob and ensure PPTX MIME
  try{
    const rawBlob = await pptx.write('blob');
    const pptxMime = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';
    let outBlob = rawBlob;
    try{ if(!rawBlob.type || !rawBlob.type.includes('presentation')) outBlob = new Blob([rawBlob], { type: pptxMime }); }catch(e){ outBlob = rawBlob; }
    return outBlob;
  }catch(err){
    console.warn('pptx write(blob) failed, trying fallback writeFile/save', err);
    try{
      const name = fileName || `evidence_${new Date().toISOString().slice(0,10)}_${layoutSel.value}ppA4.pptx`;
      if(typeof pptx.writeFile === 'function'){ await pptx.writeFile({ fileName: name }); return null; }
      else if(typeof pptx.save === 'function'){ await pptx.save(name); return null; }
      else throw err;
    }catch(e){ console.error('pptx fallback failed', e); throw e; }
  }
}
/* local downloads for manual export */
btnExportPPTX.addEventListener('click', async ()=>{
  const fileName = `evidence_${new Date().toISOString().slice(0,10)}_${layoutSel.value}ppA4.pptx`;
  const blob = await buildPPTXBlob(fileName);
  if(!blob) return; // fallback handled download
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
});
</script>

<script>
/* Add event listeners for Close and New Collection buttons */
document.addEventListener('DOMContentLoaded', () => {
  // Close button inside the Collections panel
  const collectionsClose = document.getElementById('collectionsClose');
  if (collectionsClose) {
    collectionsClose.addEventListener('click', () => {
      const panel = document.getElementById('collections');
      if (panel) {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('collections-open');
      }
    });
  }

  // New Collection button inside the Collections panel
  const newCollectionBtn = document.getElementById('newCollectionBtn');
  if (newCollectionBtn) {

    newCollectionBtn.addEventListener('click', async () => {
      // Create a new session (collection)
      const newSessionId = await createNewSession();

      // Close the Collections panel
      const panel = document.getElementById('collections');
      if (panel) {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('collections-open');
      }

      // Focus the collection title input for immediate editing
      collectionTitleInput.focus();
    });
  }
});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .catch(err => console.warn('ServiceWorker registration failed:', err));
}
</script>

<!-- Params panel wiring: toggle, populate, save (syncs to main inputs, state and sessions) -->
<script>
(function paramsPanelInit(){
  const paramsToggle = document.getElementById('paramsToggle');
  const paramsPanel = document.getElementById('paramsPanel');
  const paramsClose = document.getElementById('paramsClose');
  const paramsSave = document.getElementById('paramsSave');

  const pCollection = document.getElementById('params_collectionTitle');
  const pClient     = document.getElementById('params_clientName');
  const pProject    = document.getElementById('params_projectTitle');
  const pPhotog     = document.getElementById('params_photographerName');

  // Helper: open panel and populate values from current globals / inputs
  function openParams(){
    // populate from active session if available, otherwise from main inputs/state
    const s = sessions[activeSessionId] || {};
    pCollection.value = s.name || collectionTitleInput.value || '';
    pClient.value = s.client || clientNameInput.value || state.client || '';
    pProject.value = s.project || projectTitleInput.value || state.project || '';
    pPhotog.value = s.photographer || photographerNameInput.value || state.photographer || '';
    paramsPanel.classList.add('open');
    paramsPanel.setAttribute('aria-hidden','false');
    document.body.classList.add('params-open');
  }

  function closeParams(){
    paramsPanel.classList.remove('open');
    paramsPanel.setAttribute('aria-hidden','true');
    document.body.classList.remove('params-open');
  }

  // Save: copy params back to main inputs, state and active session then persist
  async function saveParams(){
    const valCollection = pCollection.value.trim();
    const valClient = pClient.value.trim();
    const valProject = pProject.value.trim();
    const valPhotog = pPhotog.value.trim();

    collectionTitleInput.value = valCollection;
    clientNameInput.value = valClient;
    projectTitleInput.value = valProject;
    photographerNameInput.value = valPhotog;

    state.client = valClient;
    state.project = valProject;
    state.photographer = valPhotog;

    if(activeSessionId && sessions[activeSessionId]){
      sessions[activeSessionId].name = valCollection;
      sessions[activeSessionId].client = valClient;
      sessions[activeSessionId].project = valProject;
      sessions[activeSessionId].photographer = valPhotog;
      persistSessions();
    }

    updateTabsUI && updateTabsUI(); // refresh UI summary if available
    closeParams();
  }

  if(paramsToggle) paramsToggle.addEventListener('click', ()=> {
    const open = paramsPanel.classList.contains('open');
    if(open) closeParams(); else openParams();
  });
  if(paramsClose) paramsClose.addEventListener('click', closeParams);
  if(paramsSave) paramsSave.addEventListener('click', saveParams);

  // Keep main inputs synced to state when edited (so panel picks up live values)
  clientNameInput.addEventListener('input', ()=> state.client = clientNameInput.value.trim());
  projectTitleInput.addEventListener('input', ()=> state.project = projectTitleInput.value.trim());
  photographerNameInput.addEventListener('input', ()=> state.photographer = photographerNameInput.value.trim());
  collectionTitleInput.addEventListener('input', ()=> {
    if(activeSessionId && sessions[activeSessionId]) {
      sessions[activeSessionId].name = collectionTitleInput.value.trim();
      persistSessions();
      updateTabsUI();
    }
  });

  // close panel on Escape
  document.addEventListener('keydown', e => { if(e.key === 'Escape') closeParams(); });
})();
</script>

<script>
/* ---------------- Session Manager ---------------- */
const sessions = {};
let activeSessionId = null;

async function persistSession(session) {
  await idbAddSession(session);
}

async function createNewSession(fromData = null) {
  const id = Date.now().toString();
  const base = {
    id,
    name: `Collection ${Object.keys(sessions).length + 1}`,
    client: '',
    project: '',
    photographer: '',
    items: [],
  };
  const newSession = fromData ? { ...base, ...fromData, id } : base;
  sessions[id] = newSession;
  await persistSession(newSession);
  await activateSession(id);
  return id;
}

function saveGlobalsToSession(id) {
  if (!id || !sessions[id]) return;
  const s = sessions[id];
  s.name = collectionTitleInput.value || s.name;
  s.client = state.client || s.client;
  s.project = state.project || s.project;
  s.photographer = state.photographer || s.photographer;
  s.items = state.items.slice(); // Embed full items
  persistSession(s);
}

async function loadSessionToGlobals(id) {
  if (!id || !sessions[id]) return;
  const s = sessions[id];
  state.items = s.items ? s.items.slice() : [];
  state.client = s.client || '';
  state.project = s.project || '';
  state.photographer = s.photographer || '';
  collectionTitleInput.value = s.name || '';
  clientNameInput.value = state.client;
  projectTitleInput.value = state.project;
  photographerNameInput.value = state.photographer;

  // Rebuild _preview canvases for each item to ensure thumbnails render
  for (const item of state.items) {
    if (item.dataURL && !item._preview) {
      const img = new Image();
      await new Promise(ok => { img.onload = ok; img.onerror = ok; img.src = item.dataURL; });
      const c = document.createElement('canvas');
      c.width = item.w || img.width;
      c.height = item.h || img.height;
      const ctx = c.getContext('2d');
      try { ctx.drawImage(img, 0, 0); } catch (e) {}
      item._preview = c;
    }
  }

  renderGallery();
}

async function activateSession(id) {
  if (!id || !sessions[id]) return;
  if (activeSessionId && activeSessionId !== id) {
    saveGlobalsToSession(activeSessionId);
  }
  activeSessionId = id;
  await loadSessionToGlobals(id);
  updateTabsUI();
}

async function closeSession(id) {
  if (!sessions[id]) return;
  const s = sessions[id];
  const hasData = s.items && s.items.length > 0;
  const promptMsg = hasData ? 'Delete this collection and all its photos? This cannot be undone.' : 'Delete this empty collection?';
  if (!confirm(promptMsg)) return;
  delete sessions[id];
  await idbDeleteSession(id);
  if (activeSessionId === id) {
    const keys = Object.keys(sessions);
    if (keys.length) {
      await activateSession(keys[0]);
    } else {
      await createNewSession();
    }
  }
  updateTabsUI();
}

function updateTabsUI() {
  const listEl = document.getElementById('collectionsList');
  if (listEl) {
    listEl.innerHTML = '';
    Object.values(sessions).forEach(s => {
      const li = document.createElement('li');
      li.className = 'session-tab' + (s.id === activeSessionId ? ' active' : '');      li.className = 'session-tab' + (s.id === activeSessionId ? ' active' : '');

      // Editable collection name
      const nameInput = document.createElement('input');nt.createElement('input');
      nameInput.type = 'text';
      nameInput.value = s.name || '(untitled)';'(untitled)';
      nameInput.className = 'tab';
      nameInput.title = 'Click to rename';
      nameInput.addEventListener('change', async () => {) => {
        s.name = nameInput.value.trim() || s.name;.trim() || s.name;
        await persistSession(s);ssion(s);
        updateTabsUI();
        if (s.id === activeSessionId) {
          collectionTitleInput.value = s.name; // Sync global collection title collectionTitleInput.value = s.name; // Sync global collection title
        }
      });
      // Prevent clicks on the inline input from bubbling and activating the sessionng the session
      nameInput.addEventListener('click', ev => ev.stopPropagation());      nameInput.addEventListener('click', ev => ev.stopPropagation());

      // Focus the input field when clicking the pencil button button
      const editBtn = document.createElement('button');.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'edit';';
      editBtn.innerHTML = '✏️';
      editBtn.title = 'Edit collection name';
      editBtn.addEventListener('click', (ev) => {r('click', (ev) => {
        ev.stopPropagation();();
        nameInput.focus();ameInput.focus();
      });      });

      // Small close icon to delete session — rely on closeSession() to show the confirmationoseSession() to show the confirmation
      const closeBtn = document.createElement('button');.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'close';
      closeBtn.innerHTML = '&times;';
      closeBtn.title = 'Delete collection';
      closeBtn.addEventListener('click', async (ev) => {er('click', async (ev) => {
        ev.stopPropagation();
        // closeSession will prompt the user; don't double-confirm herept the user; don't double-confirm here
        await closeSession(s.id);wait closeSession(s.id);
      });      });

      // Clicking the list item switches to that collection/sessiono that collection/session
      li.addEventListener('click', () => {ck', () => {
        activateSession(s.id);ctivateSession(s.id);
      });      });

      li.appendChild(nameInput););
      li.appendChild(editBtn);
      li.appendChild(closeBtn););
      listEl.appendChild(li);istEl.appendChild(li);
    }); });
  }  }

  const summary = document.getElementById('tabsSummary');bsSummary');
  if (summary && sessions[activeSessionId]) {
    summary.textContent = sessions[activeSessionId].name || ''; = sessions[activeSessionId].name || '';
  } else if (summary) {
    summary.textContent = ''; summary.textContent = '';
  } }
}}

async function loadPersistedSessions() {) {
  const arr = await idbAllSessions();
  if (Array.isArray(arr) && arr.length) {r) && arr.length) {
    arr.forEach(s => {
      sessions[s.id] = s;essions[s.id] = s;
    });
    await activateSession(arr[0].id);activateSession(arr[0].id);
  } else {
    await createNewSession(); await createNewSession();
  }
  updateTabsUI(); updateTabsUI();
}}

/* Session Manager UI wiring */
const collectionsToggle = document.getElementById('collectionsToggle');ggle');
const collectionsPanel = document.getElementById('collections');
const collectionsClose = document.getElementById('collectionsClose');
const newCollectionBtn = document.getElementById('newCollectionBtn');const newCollectionBtn = document.getElementById('newCollectionBtn');

collectionsToggle.addEventListener('click', () => {
  collectionsPanel.classList.add('open'); // Add the "open" class to slide inen" class to slide in
  collectionsPanel.setAttribute('aria-hidden', 'false');lse');
  document.body.classList.add('collections-open');ocument.body.classList.add('collections-open');
});
collectionsClose.addEventListener('click', () => {
  collectionsPanel.classList.remove('open'); // Remove the "open" class to slide outthe "open" class to slide out
  collectionsPanel.setAttribute('aria-hidden', 'true'););
  document.body.classList.remove('collections-open');ocument.body.classList.remove('collections-open');
});
newCollectionBtn.addEventListener('click', async () => {stener('click', async () => {
  await createNewSession();
  collectionsPanel.classList.remove('open'); // Close the panel after creating a sessionhe panel after creating a session
  collectionsPanel.setAttribute('aria-hidden', 'true'););
  document.body.classList.remove('collections-open');e('collections-open');
  collectionTitleInput.focus();ollectionTitleInput.focus();
});
window.addEventListener('beforeunload', () => saveGlobalsToSession(activeSessionId));window.addEventListener('beforeunload', () => saveGlobalsToSession(activeSessionId));

/* Initialize sessions on startup */
document.addEventListener('DOMContentLoaded', () => {
  loadPersistedSessions(); // Ensure sessions are loaded after DOM is readyoadPersistedSessions(); // Ensure sessions are loaded after DOM is ready
});
</script></script>

<script>
// Save client, project title, and photographer to state on input changeo state on input change
clientNameInput.addEventListener('input', () => {> {
  state.client = clientNameInput.value.trim();
  if (activeSessionId && sessions[activeSessionId]) {{
    sessions[activeSessionId].client = state.client;sionId].client = state.client;
    persistSessions(); persistSessions();
  }
});});

projectTitleInput.addEventListener('input', () => { {
  state.project = projectTitleInput.value.trim();
  if (activeSessionId && sessions[activeSessionId]) {
    sessions[activeSessionId].project = state.project;sionId].project = state.project;
    persistSessions(); persistSessions();
  }
});});

photographerNameInput.addEventListener('input', () => {
  state.photographer = photographerNameInput.value.trim();im();
  if (activeSessionId && sessions[activeSessionId]) {
    sessions[activeSessionId].photographer = state.photographer;sionId].photographer = state.photographer;
    persistSessions(); persistSessions();
  }
});});

collectionTitleInput.addEventListener('input', () => {ollectionTitleInput.addEventListener('input', () => {
 
  if (activeSessionId && sessions[activeSessionId]) {
    sessions[activeSessionId].name = collectionTitleInput.value.trim();sionId].name = collectionTitleInput.value.trim();
    persistSessions();();
    updateTabsUI(); updateTabsUI();
  }
});
</script>t>
</body>
</html></html>

